<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn" >
<head>
<title>内核kbuild:内核kbuild - WIKI-HIT IBM CLUB</title>
<meta name="KEYWORDS" content="首页,ALP,Address,Android,Android Newbie Guide,Android Project Development,Android Research Field,Android Third Party Lib And Tool,BoardGame,CSAPP" />
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<meta name="robots" content="index,follow" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel='stylesheet' type='text/css' media='print' href='../../../../skins/common/wikiprintable.css' />
<script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
<style type='text/css'>
/*/*/ /*<![CDATA[*/
@import "../../../../skins/common/wikistandard.css";
@import "../../../s/t/a/MediaWiki%7EStandard.css.html";
a.new, #quickbar a.new { color: #CC2200; }
.editsection { display: none; }
#quickbar { position: absolute; top: 4px; left: 4px; border-right: 1px solid gray; }
#article { margin-left: 152px; margin-right: 4px; }

/*]]>*/ /* */
</style>
</head>

<body bgcolor='#FFFFFF' onload=''>

<div id='content'>
<div id='topbar'>
<table border='0' cellspacing='0' width='98%'>
<tr>
<td width='152' rowspan='1'>&nbsp;</td><td class="top" align='left' valign='top'>
<a href="../../../index.html" title="首页">首页</a> |
<a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> |
<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑本页</a> |
<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">较早版本</a><p class='subtitle'><a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html">可打印版</a> | <a href="../../../g/e/n/WIKI-HIT_IBM_CLUB%7EGeneral_disclaimer.html" title="WIKI-HIT IBM CLUB:General disclaimer">Disclaimers</a></p>
</td>
<td class="top" valign='top' align='right' nowrap='nowrap'>Not logged in
<br /><a href="../../../u/s/e/Special%7EUserlogin.html" title="Special:Userlogin">登录</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html" title="Wikipedia:帮助">帮助</a>
<br /><form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form></td></tr>
</table>
</div>

<div id='article'>
<h1 class="pagetitle">内核kbuild:内核kbuild</h1><p class='subtitle'>Wikipedia，自由的百科全书</p>
<p>＝＝＝ 1.简介
</p><p>kbuild 可以构建正常mod和external mod
extermal 模块作者应该提供一个makefile 隐藏复杂的细节，
＝＝＝ 2.如何构建external mod
kbuild build前需要已pre－built的完整内核 a subset of the targets available when building the kernel is available when building an external module
--- 2.1 building external mod
使用下面命令build an external mod
</p><p>	make -C &lt;path-to-kernel&gt; M=`pwd`
</p><p>对running kernel	用
	make -C /lib/modules/`uname -r`/build M=`pwd`
载入模块
	make -C &lt;path-to-kernel&gt; M=`pwd` modules_install
--- 2.2 可用targets
	$KDIR 指内核源码目录
	make -C $KDIR M=`pwd` 
	加载当前目录的模块 （此时未指定模块）
	make -C $KDIR M=`pwd` modules
</p><p>	make -C $KDIR M=$PWD modules_install
</p>
<pre>		install the external modules
</pre>
<p>		默认在/lib/modules/&lt;kernel-version&gt;/extra
		可以改变INSTALL_MOD_PATH 
	make -C $KDIR M=$PWD clean
		删除所有相关文件
	make -C $KDIR M=`pwd` help 
		list所有可用targets 
－－－2.3  可用选项
	$KDIR 指 内核源码路径
	make -C $KDIR 
		specify 内核源码路径 make会个改变dir when executed 但改回来when finished
	make -C $KDIR M=`pwd`
		M=告诉kbulid an external mod is being built
		pwd可换为mod（kbuild file）的位置
		when an external module is being built only a subset of the usual targets are available
	make -C $KDIR SUBDIRS=`pwd`
		和上面一样 subdirs是为向下兼容
---2.4 准备内核树为 mod build
	要确保内核知道所有编译external mod的信息 必须用到target modules_prepare
	note&nbsp;: modules_prepare 不会build Module.symvers 即使设定了CONFIG_MODULEVERSIONING.
		因此 完整的内核编译需要module versioning work
---2.5 building separate files for a module
	可以构建一个作为模块一部分呢的单独文件
		make -C $KDIR M=`pwd` bar.lst
		make -C $KDIR M=`pwd` bar.o
		make -C $KDIR M=`pwd` foo.ko
		make -C $KDIR M=`pwd` /
===3. 命令示例
下面是一些示例
示例中supposed to使用facility 定位输入文件于不同于源文件的目录 但目录相同的话也不会有影响
＃kernel source
/lib/modules/&lt;kernel-version&gt;/source -&gt; /usr/src/linux-&lt;version&gt;
</p>
<ol><li>output from kernel compile
</li></ol>
<p>/lib/modules/&lt;kernel-version&gt;/build -&gt; /usr/src/linux-&lt;version&gt;-up
	cd /home/user/src/module
	make -C /usr/src/`uname -r`/source 
		O=/lib/modules/`uname -r`/build
		M=`pwd`
	make -C /usr/src/`uname -r`/source
		O=/lib/modules/`uname -r`/build
		M=`pwd`
		modules_install
＝＝＝4.创建一个kbuild文件
kbuild is the build system for the kernel ,and external modules must use kbuild to stay compatible with changes in the build system and to pick up the right flags to gcc 
kbuild file 参考 kbuild/makefiles.txt
以下示例将建立一个makefile with下面文件
	8123_if.c
	8123_if.h
	8123_pci.c
	8123_bin.o_shipped &lt;= Binary blob
--- 4.1 shared makefile for module and kernel
	an external module always include a wrapper Makefile supporting building the module using 'make' with no arguments.
The Makefile provided will most likely include additional functionality such as test targets etc.and this part shall be fitered away from kbuild since it may impact kbuild if name clashes occurs.
	--&gt;filename&nbsp;: Makefile
		ifneq ($(KERNELRELEASE),)
		#kbuild part of makefile 
		obj-m&nbsp;:= 8123.o
		8123-y&nbsp;:=8123_if.o 8123_pci.o 8123_bin.o
		else 
		#normal Makefile
		KERNELDIR&nbsp;:= /lib/modules/`uname -r`/build
		all::
			$(MAKE) -C $(KERNELDIR) M='pwd` $@
		#Module specific targets
		genbin:
			echo "X" &gt; 8123_bin.o_shipped
		endif
---4.2 binary blobs included in a module
	somen external modules needs to include a .o as a blob.但文件名需要后缀_shipped.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑</a>]</div><a name=".3D"></a><h1>=</h1> 5. 头文件
<p>--- 5.1 如何包含内核头文件
	＃include &lt;linux/modules.h&gt;
	kbuild会向gcc传递相关参数确保头文件目录被找到
	# include "8123_if.h"
--- 5.2 external mod 使用an include/ dir
	external mod 通常使用单独头文件目录，且不同于内核风格。当其使用include/ dir 时 需告诉kbuild
	使用 EXTRA_CFLAGS take effect for all .c files  CFLAGS_$F.o take effect only for a single file
	如本例中若将.h放在include/中 
		--&gt; filename&nbsp;: Kbuild
		obj-m&nbsp;:= 8123.o
		EXTRA_CFLAGS&nbsp;:= -Iinclude
		8123-y&nbsp;:=8123_if.o 8123.pci.o 8123_bin.o
	note: there is no space between -I and the path 
--- 5.3 external mod 使用多个目录	
	|
	+- src/complex_main.c
	|   +- hal/hardwareif.c
	|   +- hal/include/hardwareif.h
	+- include/complex.h
</p><p>	Kbuild:
		obj-m&nbsp;:= complex.o
		complex-y&nbsp;:= src/complex_main.o
		complex-y += src/hal/hardwareif.o
</p><p>		EXTRA_CFLAGS&nbsp;:= -I$(src)/include
		EXTRA_CFLAGS += -I$(src)src/hal/include
	$src is the dir where kbuild file in
＝＝＝6. 加载模块
一般模块安装在/lib/modules/$(KERNELRELEASE)/kernel
external mod /lib/modules/$(KERNELRELEASE)/extra
--- 6.1 INSTALL_MOD_PATH
		$ make INSTALL_MOD_PATH=/frodo modules_install
		=&gt; Install dir: /frodo/lib/modules/$(KERNELRELEASE)/kernel
--- 6.2 INSTALL_MOD_DIR
	one can use INSTALL_MOD_DIR to specify an alternative name than "extra"
		$ make INSTALL_MOD_DIR=GANDALF -c derneldir \
			M=`pwd` modules_install
		=&gt; Install dir: /lib/modules/$(KERNELRELEASE)/gandalf
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑</a>]</div><a name=".3D_2"></a><h1>=</h1> 7.module versioning &amp; Module.symvers
<p>Module versioning is used as a simple ABI consistency check. The Module
versioning creates a CRC value of the full prototype for an exported symbol and
when a module is loaded/used then the CRC values contained in the kernel are
compared with similar values in the module. If they are not equal then the
kernel refuses to load the module.
</p><p>Module.symvers contains a list of all exported symbols from akernel build.
--- 7.1 Symbols from the kernel (vmlinux + modules)
	During a kernel build a file named Module.symvers will be generated.
	Module.symvers contains all exported symbols from the kernel and
	compiled modules. For each symbols the corresponding CRC value
	is stored too.
</p><p>	The syntax of the Module.symvers file is:
		&lt;CRC&gt;       &lt;Symbol&gt;           &lt;module&gt;
	Sample:
		0x2d036834  scsi_remove_host   drivers/scsi/scsi_mod
</p><p>	For a kernel build without CONFIG_MODVERSIONING enabled the crc
	would read: 0x00000000
</p><p>	Module.symvers serve two purposes.
	1) It list all exported symbols both from vmlinux and all modules
	2) It list CRC if CONFIG_MODVERSION is enabled
--- 7.2 symbols and external modules
</p><p>	When building an external module the build system needs access to
	the symbols from the kernel to check if all external symbols are
	defined. This is done in the MODPOST step and to obtain all
	symbols modpost reads Module.symvers from the kernel.
	If a Module.symvers file is present in the directory where
	the external module is being build this file will be read too.
	During the MODPOST step a new Module.symvers file will be written
	containing all exported symbols that was not defined in the kernel.
--- 7.3 symbols from another external module
</p><p>	Use a top-level Kbuild file
		If you have two modules: 'foo', 'bar' and 'foo' needs symbols
		from 'bar' then one can use a common top-level kbuild file so
		both modules are compiled in same build.
</p><p>		Consider following directory layout:
		./foo/ &lt;= contains the foo module
		./bar/ &lt;= contains the bar module
		The top-level Kbuild file would then look like:
</p><p>		#./Kbuild: (this file may also be named Makefile)
			obj-y&nbsp;:= foo/ bar/
</p><p>		Executing:
			make -C $KDIR M=`pwd`
</p><p>		will then do the expected and compile both modules with full
		knowledge on symbols from both modules.
	Use an extra Module.symvers file
		copy Module.symvers 
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑</a>]</div><a name=".3D_3"></a><h1>=</h1> 8. Tips &amp; Tricks
<p>--- 8.1 Testing for CONFIG_FOO_BAR
</p><p>	Modules often needs to check for certain CONFIG_ options to decide if
	a specific feature shall be included in the module. When kbuild is used
	this is done by referencing the CONFIG_ variable directly.
</p><p>		#fs/ext2/Makefile
		obj-$(CONFIG_EXT2_FS) += ext2.o
</p><p>		ext2-y&nbsp;:= balloc.o bitmap.o dir.o
		ext2-$(CONFIG_EXT2_FS_XATTR) += xattr.o
</p>
<div class="printfooter">
<p>取自"<a href="http://dns.cs.hit.edu.cn../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html">http://dns.cs.hit.edu.cn../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html</a>"</p>

<p>本页面已经被浏览10次。 This page was last modified 11:43 2007年3月6日 by <a href="../../../%E4%BD%95/%E6%98%A5/%E6%99%93/User%7E%E4%BD%95%E6%98%A5%E6%99%93.html" title="User:何春晓">何春晓</a>.  </p>
</div>

</div><br style="clear:both" />

<div id='footer'><table border="0" cellspacing="0"><tr><td width='152' rowspan='1'>&nbsp;</td><td class='bottom' align='left' valign='top'><strong><a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑本页</a></strong> |
<a href="../../../%E5%86%85/%E6%A0%B8/k/Talk%7E%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" class="new" title="Talk:内核kbuild:内核kbuild">讨论本页</a> |
<a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">较早版本</a> |
<a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a> |
<a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><br />

<br /><a href="../../../index.html" title="首页">首页</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%85%B3%E4%BA%8E.html" title="Wikipedia:关于">关于Wikipedia</a> | <a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> | <form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form><br /><span id="pagestats">本页面已经被浏览10次。 This page was last modified 11:43 2007年3月6日 by <a href="../../../%E4%BD%95/%E6%98%A5/%E6%99%93/User%7E%E4%BD%95%E6%98%A5%E6%99%93.html" title="User:何春晓">何春晓</a>.  </span></td></tr></table>
</div>
</div>

<div id='quickbar'>
<a href='../../../index.html'><img src='../../../../skins/common/images/wiki.jpg' alt='[首页]' /></a>
<hr class='sep' /><a href="../../../index.html">首页</a>
<br /><a href="../../../c/o/m/WIKI-HIT_IBM_CLUB%7ECommunity_Portal_9150.html">社区</a>
<br /><a href="../../../c/u/r/Current_events.html">新闻动态</a>
<br /><a href="../../../r/e/c/Special%7ERecentchanges.html">最近更改</a>
<br /><a href="../../../r/a/n/Special%7ERandom.html">随机页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html">帮助</a>
<br /><a href="../../../s/i/t/WIKI-HIT_IBM_CLUB%7ESite_support.html">Donations</a>
<br />
<hr class='sep' /><strong><a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">编辑本页</a></strong>
<br /><a href="../../../%E5%86%85/%E6%A0%B8/k/Talk%7E%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" class="new" title="Talk:内核kbuild:内核kbuild">讨论本页</a>
<br /><a href="../../../%E5%86%85/%E6%A0%B8/k/%E5%86%85%E6%A0%B8kbuild%7E%E5%86%85%E6%A0%B8kbuild.html" title="内核kbuild:内核kbuild">较早版本</a>
<br /><a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a>
<br /><a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><hr class='sep' /><a href="../../../s/p/e/Special%7ESpecialpages.html" title="Special:Specialpages">特殊页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A.html" title="Wikipedia:错误报告">错误报告</a>
<br /></div>
<!-- Served by dns.cs.hit.edu.cn in 1351393063.18 secs. -->
</body></html>