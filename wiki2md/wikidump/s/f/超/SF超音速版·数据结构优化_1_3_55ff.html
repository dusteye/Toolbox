<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn" >
<head>
<title>SF超音速版·数据结构优化 1/3 - WIKI-HIT IBM CLUB</title>
<meta name="KEYWORDS" content="首页,ALP,Address,Android,Android Newbie Guide,Android Project Development,Android Research Field,Android Third Party Lib And Tool,BoardGame,CSAPP" />
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<meta name="robots" content="index,follow" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel='stylesheet' type='text/css' media='print' href='../../../../skins/common/wikiprintable.css' />
<script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
<style type='text/css'>
/*/*/ /*<![CDATA[*/
@import "../../../../skins/common/wikistandard.css";
@import "../../../s/t/a/MediaWiki%7EStandard.css.html";
a.new, #quickbar a.new { color: #CC2200; }
.editsection { display: none; }
#quickbar { position: absolute; top: 4px; left: 4px; border-right: 1px solid gray; }
#article { margin-left: 152px; margin-right: 4px; }

/*]]>*/ /* */
</style>
</head>

<body bgcolor='#FFFFFF' onload=''>

<div id='content'>
<div id='topbar'>
<table border='0' cellspacing='0' width='98%'>
<tr>
<td width='152' rowspan='1'>&nbsp;</td><td class="top" align='left' valign='top'>
<a href="../../../index.html" title="首页">首页</a> |
<a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> |
<a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">编辑本页</a> |
<a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">较早版本</a><p class='subtitle'><a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html">可打印版</a> | <a href="../../../g/e/n/WIKI-HIT_IBM_CLUB%7EGeneral_disclaimer.html" title="WIKI-HIT IBM CLUB:General disclaimer">Disclaimers</a></p>
</td>
<td class="top" valign='top' align='right' nowrap='nowrap'>Not logged in
<br /><a href="../../../u/s/e/Special%7EUserlogin.html" title="Special:Userlogin">登录</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html" title="Wikipedia:帮助">帮助</a>
<br /><form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form></td></tr>
</table>
</div>

<div id='article'>
<h1 class="pagetitle">SF超音速版·数据结构优化 1/3</h1><p class='subtitle'>Wikipedia，自由的百科全书</p>
<p>　前面谈了SF源代码的一些写作细节上的问题，主要是为了让大家看着不觉得奇怪，现在我们就来描述一下SF超音速版的数据结构吧，从中可以看出SF是怎样对超高速检索进行支持的。
</p><p>一、高速检索的一些基本原则。
</p><p>前面谈的是从程序角度对高速检索的支持，这里主要从数据结构或说算法角度。其实从总体上来说，从程序角度所进行的优化是一种微观上的优化，从全局上来讲是很有限的（当然，这并不是说我们就可以完全忽回略掉程序优化，从前面的讨论中应当已经可以看出，某些时候一种好的写法会比一种蜗牛写法节省上亿次的CPU运算时间，这在数据量巨大时相当可观），而数据结构及算法上的优化是一种全局的优化，能显著的，呈数量级的趋势提高系统的运算速度，故而，我们应当仔细设计这一部份。
　　
</p><p>从整个计算机结构上来讲，抛开CPU不谈，现在主要的瓶颈是集中在存储结构上面，寄存器访问最快，其次是cache，再次是内存，最蜗牛的是访问硬盘。因此，我们要尽最大的努力减少对磁盘的访问，也就是说尽量让从磁盘读到内存中的数据尽可能的少，而让尽可能多的操作直接在内存中完成，另外，还要尽可能的注意不要过多的breake cache，尽可能的使用寄存器，只有这样才能使系统高速运转。
</p><p>1.1 合理使用寄存器
　　
</p><p>来看看前面提到过的一个例子：
</p>
<pre>for(int i = 0; i &lt; vector1.size(); ++i)
{
   .....
}
</pre>
<p>上面的这种写法就不是一种好的写法，改成下面这样就比较好：
</p>
<pre>register int size = vector1.size();
for(register int i = 0; i &lt; size; ++i)
{
   .....
}
</pre>
<p><br />
这里，用了register来建议编译器尽量的把这些值放入寄存器中，使每次访问可以直接在寄存器里完成，这样的速度就会高很多。
</p><p><br />
1.2 合理使用cache
</p><p><br />
对于cache而言，这部份基本上无法由我们控制，但是我们可以尽量从cache的原理上着手，减小cache被break的几率。也就是说我们应当是访问的内存尽量集中。我们知道，当访问一个内存地址的时候，如果这个内存地址不在cache中，那么就会发生cache miss，这个时候，硬件会把包含这个内存地址的一整块内存都载入到cache中来，因此，如果这时候我们在访问与这个内存地址相临的地址时，就可以直接在cache中命中了，而无需要再次载入了，下面考虑这样一种情况，有一个结构体数组：
</p>
<pre>struct S
{
   int a;
   int b;
   int c;
   int d;
};
</pre>
<pre>S item[100];
</pre>
<pre>for(int i = 0; i &lt; 100; ++i)
{
   item[i].a *= 2;
}
</pre>
<p>上面这个结构体中，每个结构体占4 * 4 = 16B的空间，而在这个循环中，我每次只访问了这个结构体中的第一个成员a，假设item[0]的地址为0，那么我们访问的地址空间依次是：
</p>
<pre>0、16、32、48、64、80、96、112、128……
</pre>
<p>现在我们又假设每次cache miss后，硬件会载入访问地址的相临的16B的内存块，那么，上面cache的情况就会是：
</p>
<pre>访问内存地址0：不命中，载入16B的内存块，即载入的内存地址范围为0~15
访问内存地址16：由于先前载入的内存地址范围为0~15，故而还是不命中，这次又载入的内存地址范围变成16~31
访问内存地址32：由于先前载入的内存地址范围为16~31，故而此时还是不命中，这次又载入的内存地址范围又变成32~47
访问内存地址48：……
……
</pre>
<p><br />
可见，在这种情况下，几乎cache每次都不能命令，每次都要从内存中去读值。下面，我们换一种方式，由于只访问了S的成员a，所以我就把成员工单独分离出来，把一个结构拆成两个：
</p>
<pre>struct S1
{
   int a;
};
</pre>
<pre>struct S2
{
   int b;
   int c;
   int d;
};
</pre>
<pre>S1 item1[100];
S2 item2[100];
</pre>
<pre>for(int i = 0; i &lt; 100; ++i)
{
   item1[i].a *= 2;
}
</pre>
<p><br />
这里，我们让item1与item2通过同一个下标一一对应，这样，就可以完全同先前的item对应起来了。这时，我们再来看看对其成员a的访问，仍然假设item1[0]的地址为0，则访问的内存地址即变为：
</p>
<pre>0、4、8、12、16、20、24、28、32……
</pre>
<p>现在来看看cache的命中情况：
</p>
<pre>访问内存地址0：不命中，载入16B的内存块，即载入的内存地址范围为0~15
访问内存地址4：由于先前载入的内存地址范围为0~15，故命中
访问内存地址8：命中
访问内存地址12：命中
访问内存地址16：不命中，载入16B的内存块，即载入的内存地址范围变为16~31
访问内存地址20：命中
……
</pre>
<p><br />
可见，这样一改之后，cache的命中率大幅提高，这表明了一点，对于大结构体的处理一定要慎重，应仔细考虑其是否可以拆成一些小结构体数组，这样对内存的访问影响可能会非常显著。
</p><p>1.3 合理使用内存
</p><p>其实内存的使用同cache一样，对于程序员来说也是比较透明的，对于cache，我们可能会从cache的原理进行优化考虑，对于内存我们可以从操作系统对于内存入手进行优化考虑。我们知道，现代的操作系统都支持虚拟内存这一方式，即会将一块不常使用的内存页调出，存到磁盘上，那么，我们就应当想一些办法来减少内存页被操作系统调出的可能性。当然最好的办法就是多多使用某页内存，另一种办法就是想法让操作系统把一块内存“锁住”。
</p><p>对于后一种方法，我们可以调一些操作系统的函数来“锁”住内存，让其不被操作系统交换出去，比如说对一些共享内存及内存映射文件，操作系统都可以将其“锁”在内存中。但是这种方法并不是每次都能有效的，一般可“锁住”的内存都有大小限制，只能将一些小内存“锁”在内存中。
　　
对于前一种方法来说，除了尽量访问相邻的地址空间外，还需要尽可能的减少malloc及free的次数，比如下面一段代码：
</p>
<pre>int* mem = (int *)malloc(1024 * sizeof(int));
for(int i = 0; i &lt; 1024; ++i)
{
   mem[i] = .....
}
......
free(mem);
short* p = (short *)malloc(1024 * sizeof(int));
for(int i = 0; i &lt; 1024; ++i)
{
   p[i] = ......
}
......
free(p);
</pre>
<p>　　
上面的这种写法其实不是一个很好的内存使用策略，考虑这样一种极端一点的情况，第一次分配的空间为1024 * 4B = 4KB，刚好为一个内存页（对于现在一般在Intel IA32架构下的操作系统，一般是将4KB做为内存页的大小），这时，你free()，那么系统很可能就立即把这一页过释放了，这一页内存也许会立刻被交换到磁盘上去，这时，你又进行了一次malloc()分配，系统还得另寻一块内存给你，这样做是非常慢的。我们注意到，第二次所需要分配的内存空间比第一次分配的少，那么我们完全可以直接使用第一次分配的空间，等用完后再释放它，如下所示：
</p>
<pre>int* mem = (int *)malloc(1024 * sizeof(int));
for(int i = 0; i &lt; 1024; ++i)
{
   mem[i] = .....
}
......
short* p = (short *)mem;
for(int i = 0; i &lt; 1024; ++i)
{
   p[i] = ......
}
......
free(p);
</pre>
<p>　　
这样，我们就减少了一次内存的分配与释放，并且，这块内存一直在被使用，也就相应的减少了被交换出去的可能，这种方式显示比第一种方式要好。这里我们可以看出，延迟内存的释放也是有一定积极意义的。当然，这需要小心操作，因为有可能导致无用的内存过多，反倒是一此有用的内存被交换出去了，这需要程序员对于系统内存大小、负载大小进行一个估计，合理的制定策略。
</p><p><br />
1.4 合理使用磁盘
</p><p>对于磁盘的使用主要就是减少从磁盘到内存的数据量读入，减少fread这些函数的调用，一般而言，对于一文件使用“内存映射文件”的访问方式比较好，这样，可以把一个文件映射进内存，访问的时候就相当于访问内存一样，可以省掉不少的诛如fread()这类函数的调用开销。
</p><p>另外对于磁盘上的文件而言，与前面所介绍的处理struct的方式一样，如果我们每次只用到一个大文件的很少一部份，我们可以把大文件分成几个小文件，然后，把需要集中访问的数据集中在一个个的小文件中，这样，可以使每次从磁盘读入的数据量大大减小。
</p><p>好了，关于一般的原则就介绍到这里吧，下面将详细描述一下SF对这些东东的处理。
</p>
<div class="printfooter">
<p>取自"<a href="http://dns.cs.hit.edu.cn../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html">http://dns.cs.hit.edu.cn../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html</a>"</p>

<p>本页面已经被浏览12次。 This page was last modified 07:14 2006年5月9日 by <a href="../../../c/o/w/User%7ECowoo.html" title="User:Cowoo">陈伟</a>.  </p>
</div>

</div><br style="clear:both" />

<div id='footer'><table border="0" cellspacing="0"><tr><td width='152' rowspan='1'>&nbsp;</td><td class='bottom' align='left' valign='top'><strong><a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">编辑本页</a></strong> |
<a href="../../../s/f/%E8%B6%85/Talk%7ESF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_4600.html" class="new" title="Talk:SF超音速版·数据结构优化 1/3">讨论本页</a> |
<a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">较早版本</a> |
<a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a> |
<a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><br />

<br /><a href="../../../index.html" title="首页">首页</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%85%B3%E4%BA%8E.html" title="Wikipedia:关于">关于Wikipedia</a> | <a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> | <form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form><br /><span id="pagestats">本页面已经被浏览12次。 This page was last modified 07:14 2006年5月9日 by <a href="../../../c/o/w/User%7ECowoo.html" title="User:Cowoo">陈伟</a>.  </span></td></tr></table>
</div>
</div>

<div id='quickbar'>
<a href='../../../index.html'><img src='../../../../skins/common/images/wiki.jpg' alt='[首页]' /></a>
<hr class='sep' /><a href="../../../index.html">首页</a>
<br /><a href="../../../c/o/m/WIKI-HIT_IBM_CLUB%7ECommunity_Portal_9150.html">社区</a>
<br /><a href="../../../c/u/r/Current_events.html">新闻动态</a>
<br /><a href="../../../r/e/c/Special%7ERecentchanges.html">最近更改</a>
<br /><a href="../../../r/a/n/Special%7ERandom.html">随机页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html">帮助</a>
<br /><a href="../../../s/i/t/WIKI-HIT_IBM_CLUB%7ESite_support.html">Donations</a>
<br />
<hr class='sep' /><strong><a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">编辑本页</a></strong>
<br /><a href="../../../s/f/%E8%B6%85/Talk%7ESF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_4600.html" class="new" title="Talk:SF超音速版·数据结构优化 1/3">讨论本页</a>
<br /><a href="../../../s/f/%E8%B6%85/SF%E8%B6%85%E9%9F%B3%E9%80%9F%E7%89%88%C2%B7%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%BC%98%E5%8C%96_1_3_55ff.html" title="SF超音速版·数据结构优化 1/3">较早版本</a>
<br /><a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a>
<br /><a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><hr class='sep' /><a href="../../../s/p/e/Special%7ESpecialpages.html" title="Special:Specialpages">特殊页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A.html" title="Wikipedia:错误报告">错误报告</a>
<br /></div>
<!-- Served by dns.cs.hit.edu.cn in 1351392686.21 secs. -->
</body></html>