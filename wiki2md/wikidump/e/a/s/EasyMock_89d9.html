<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-cn" lang="zh-cn" >
<head>
<title>EasyMock - WIKI-HIT IBM CLUB</title>
<meta name="KEYWORDS" content="首页,ALP,Address,Android,Android Newbie Guide,Android Project Development,Android Research Field,Android Third Party Lib And Tool,BoardGame,CSAPP" />
<meta http-equiv="Content-type" content="text/html; charset=UTF-8" />
<meta name="robots" content="index,follow" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel='stylesheet' type='text/css' media='print' href='../../../../skins/common/wikiprintable.css' />
<script type="text/javascript" src="../../../../skins/common/wikibits.js"></script>
<style type='text/css'>
/*/*/ /*<![CDATA[*/
@import "../../../../skins/common/wikistandard.css";
@import "../../../s/t/a/MediaWiki%7EStandard.css.html";
a.new, #quickbar a.new { color: #CC2200; }
.editsection { display: none; }
#quickbar { position: absolute; top: 4px; left: 4px; border-right: 1px solid gray; }
#article { margin-left: 152px; margin-right: 4px; }

/*]]>*/ /* */
</style>
</head>

<body bgcolor='#FFFFFF' onload=''>

<div id='content'>
<div id='topbar'>
<table border='0' cellspacing='0' width='98%'>
<tr>
<td width='152' rowspan='1'>&nbsp;</td><td class="top" align='left' valign='top'>
<a href="../../../index.html" title="首页">首页</a> |
<a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> |
<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑本页</a> |
<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">较早版本</a><p class='subtitle'><a href="../../../e/a/s/EasyMock_89d9.html">可打印版</a> | <a href="../../../g/e/n/WIKI-HIT_IBM_CLUB%7EGeneral_disclaimer.html" title="WIKI-HIT IBM CLUB:General disclaimer">Disclaimers</a></p>
</td>
<td class="top" valign='top' align='right' nowrap='nowrap'>Not logged in
<br /><a href="../../../u/s/e/Special%7EUserlogin.html" title="Special:Userlogin">登录</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html" title="Wikipedia:帮助">帮助</a>
<br /><form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form></td></tr>
</table>
</div>

<div id='article'>
<h1 class="pagetitle">EasyMock</h1><p class='subtitle'>Wikipedia，自由的百科全书</p>
<table id='toc' class='toc'><tr><td><div id='toctitle'><h2>目录</h2></div>
<ul>
<li class='toclevel-1'><a href="#.E6.80.BB.E7.BB.93"><span class="tocnumber">1</span> <span class="toctext">总结</span></a></li>
<li class='toclevel-1'><a href="#.E7.BC.96.E8.AF.91.E6.9C.9F.E7.B1.BB.E5.9E.8B.E6.A3.80.E6.9F.A5"><span class="tocnumber">2</span> <span class="toctext">编译期类型检查</span></a></li>
<li class='toclevel-1'><a href="#.E8.BF.94.E5.9B.9E.E5.80.BC.E6.88.96.E5.BC.82.E5.B8.B8"><span class="tocnumber">3</span> <span class="toctext">返回值或异常</span></a></li>
<li class='toclevel-1'><a href="#Exception:_missing_behavior_definition_for_the_preceeding_method_call"><span class="tocnumber">4</span> <span class="toctext">Exception: missing behavior definition for the preceeding method call</span></a></li>
<li class='toclevel-1'><a href="#.E5.85.B3.E4.BA.8Eunexpect.E6.96.B9.E6.B3.95.EF.BC.88Behavior.EF.BC.89.E7.9A.84.E5.A4.84.E7.90.86"><span class="tocnumber">5</span> <span class="toctext">关于unexpect方法（Behavior）的处理</span></a></li>
<li class='toclevel-1'><a href="#.E5.AF.B9.E5.BA.94.E5.85.B3.E7.B3.BB"><span class="tocnumber">6</span> <span class="toctext">对应关系</span></a></li>
<li class='toclevel-1'><a href="#verify.28.29.E7.9A.84.E5.AE.9E.E7.8E.B0"><span class="tocnumber">7</span> <span class="toctext">verify()的实现</span></a></li>
<li class='toclevel-1'><a href="#replay.28.29.E7.9A.84.E5.AE.9E.E7.8E.B0"><span class="tocnumber">8</span> <span class="toctext">replay()的实现</span></a></li>
<li class='toclevel-1'><a href="#7.E6.9C.8823.E6.97.A5"><span class="tocnumber">9</span> <span class="toctext">7月23日</span></a></li>
<li class='toclevel-1'><a href="#andReturn.28.29"><span class="tocnumber">10</span> <span class="toctext">andReturn()</span></a></li>
</ul>
</td></tr></table>
<p><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "显示"; var tocHideText = "隐藏"; showTocToggle(); } </script>
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name=".E6.80.BB.E7.BB.93"></a><h2> 总结 </h2>
<ol><li>EasyMock的相关概念:
<ol><li>Matcher——用于判断入口参数的各种关系的类。
</li><li>Answer——似乎是让mock对象的方法在调用的时候返回制定的值、或抛出制定异常的类。
</li><li>Result——含有mock对象的方法返回值。
</li></ol>
</li><li>EasyMock中核心的几个类：
<ol><li>Invocation——对应于一个实际的方法（Method）。这个类中有三个私有成员：Object mock、Method method、Object[] arguments，对应着要进行mock的对象、该对象的一个方法、这个方法的参数。
</li><li>ExpectedInvocation——对应于一个expectMethod，其中包含的私有对象为Invocation invocation、ArgumentsMatcher matcher、List matchers。从它的三个参数的构造方法我们可以看出matcher和matchers这两个参数不是同时有效的，matcher的优先级比matchers要高，只有当matcher==null的时候才会用matchers。
</li><li>ExpectedInvocationAndResult——类似于ExpectedInvocation，但是增加了一个Result成员，用于规定这个方法的返回值。
</li><li>ExpectedInvocationAndResults——类似于ExpectedInvocationAndResult，这次的返回值用Result数组来规定。
</li><li>UnorderedBehavior——对应于一组预期的方法，并完成verify()的功能。私有成员有两个：boolean checkOrder、ArrayList results。checkOrder用于标记是否检查函数调用的顺序，results用于保存一组ExpectedInvocationAndResults对象。（对这个类的各个方法的含义及使用场景还是没弄明白）
</li><li>EasyMock——这个类是被要求import static 的类，开始由于里面含有大量的判断相等的方法，没有看，后来看到最后，又看回这个类，发现思路一下子清晰了很多，发现了Thread的踪迹，从而才知道它是怎样获得和记录mock对象的方法的。
</li></ol>
</li></ol>
<p>（还有一些比如JavaProxyFactory类没有看懂，整体的处理流程还要继续归纳，争取明天能够形成文档）
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name=".E7.BC.96.E8.AF.91.E6.9C.9F.E7.B1.BB.E5.9E.8B.E6.A3.80.E6.9F.A5"></a><h2>编译期类型检查</h2>
<p>mock.expect(Behavior).andReturn(returnValue);//在编译期提供返回值类型检查
</p><p>mock.Behavior();
ExpectLastCall().andReturn(returnValue);//这样做不提供编译期的类型检查，不推荐使用，除非为了缩短行代码长度
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name=".E8.BF.94.E5.9B.9E.E5.80.BC.E6.88.96.E5.BC.82.E5.B8.B8"></a><h2>返回值或异常</h2>
<p>Inside an IAnswer callback, the arguments passed to the mock call are available via EasyMock.getCurrentArguments(). If you use these, refactorings like reordering parameters may break your tests. You have been warned.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name="Exception:_missing_behavior_definition_for_the_preceeding_method_call"></a><h2>Exception: missing behavior definition for the preceeding method call </h2>
<p>"missing behavior definition for the preceeding method call " + lastInvocation.toString();
</p><p>这个错误是在org.easymock.internal.RecordState.closeMethod()报出的。这个方法是由replay()内部调用的，报错条件是
</p>
<pre>!isLastResultOrVoidMethod()
</pre>
<p>isLastResultOrVoidMethod()这个方法的实现是：
</p>
<pre>return lastResult&nbsp;!= null || lastMethodIsVoidMethod();
</pre>
<p>lastMethodIsVoidMethod()的实现：
</p>
<pre>Class returnType = lastInvocation.getMethod().getReturnType();
return returnType.equals(Void.TYPE);
</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name=".E5.85.B3.E4.BA.8Eunexpect.E6.96.B9.E6.B3.95.EF.BC.88Behavior.EF.BC.89.E7.9A.84.E5.A4.84.E7.90.86"></a><h2> 关于unexpect方法（Behavior）的处理 </h2>
<p>在MockControl中有这样三段注释：
</p>
<pre>An unexpected method call on the mock object will lead to an AssertionError —— createControl()
</pre>
<pre>An unexpected method call on the mock object will lead to an AssertionError —— createStrictControl()
</pre>
<pre>An unexpected method call on the mock object will return an empty value (0, null, false) —— createNiceControl()

</pre>
<p>也就是说当调用了前面没有expect的mock对象方法时，除了NiceControl，另外两种control都会报出AssertionError这个EasyMock中的最常见错误
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name=".E5.AF.B9.E5.BA.94.E5.85.B3.E7.B3.BB"></a><h2> 对应关系 </h2>
<p>Invocation &lt;==&gt; Actual Method
</p><p>ExpectedInvocation &lt;==&gt; Mock Method (Actual Method + Matcher(s) ) 
</p><p>重要的核心类：Invocation ExpectedInvocation UnorderedBehavior MocksBehavior
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name="verify.28.29.E7.9A.84.E5.AE.9E.E7.8E.B0"></a><h2> verify()的实现 </h2>
<p>找了半天，似乎只有UnorderedBehavior里有真正的实现，其他的都是直接或间接调用。
</p>
<pre>   public boolean verify() {
       for (ExpectedInvocationAndResults entry&nbsp;: results) {
           if (!entry.getResults().hasValidCallCount()) {
               return false;
           }
       }
       return true;
   }
</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name="replay.28.29.E7.9A.84.E5.AE.9E.E7.8E.B0"></a><h2> replay()的实现 </h2>
<p>位于internal.RecordState类中
</p>
<pre>   public void replay() {
       closeMethod();
       if (LastControl.pullMatchers()&nbsp;!= null) {
           throw new IllegalStateException("matcher calls were not used outside expectations");
       }
   }
</pre>
<pre>   private void closeMethod() {
       if (lastInvocationUsed &amp;&amp; lastResult == null) {
           return;
       }
       if (!isLastResultOrVoidMethod()) {
           throw new RuntimeExceptionWrapper(new IllegalStateException(
                   "missing behavior definition for the preceeding method call "
                           + lastInvocation.toString()));
       }
       this.times(MockControl.ONE);
   }
</pre>
<p>他的功能就是标志结束record过程，并检查录制过程中是否缺少或多余一些东西，比如是否有多出来的Matcher（matcher只能在入口参数那里使用，之外的地方不能出现），是否缺少方法的返回值。
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name="7.E6.9C.8823.E6.97.A5"></a><h2> 7月23日 </h2>
<p>今天把easymock的源码加进来debug了一下,发现似乎ObjectMethodFilter MockInvocationHandler IMocksControlState中的invoke()是核心的方法,也许现在再说哪个函数或类是核心方法已经意义不大了,或者说不太好说清楚了，不过目前已经对easymock的流程比较了解了。现在还搞不清楚实际运行方法时的返回值是在什么时候，在什么对象中保存的，其余的已经基本初步明朗。
</p><p>首先，建立control对象的时候，它会自动建立其成员behavior和RecordState state
在建立Mock对象的时候，它会自动建立JavaProxyFactory&lt;toMock&gt;,再由JavaProxyFactory建立Proxy；同时建立的还有ObjectMethodFilter和MockInvocationHandler
在record过程中，如果使用了Eq()之类的匹配器，它会将相应的Matcher以及当前线程压入到LastControl的一个static堆栈WeakHashMap&lt;Thread, Stack&lt;IArgumentMatcher&gt;&gt; threadToArgumentMatcherStack中。建立一个Invocation对象用于保存一条mock对象的方法调用。……之后调用invoke()方法，……结束之后，最后运行mock对象的那个方法，接下来是expect()的过程。（后面的跳得太频繁了，跟晕了，先暂停一下）
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑</a>]</div><a name="andReturn.28.29"></a><h2> andReturn() </h2>
<p>一直以为这个函数是在record期用来设置一个预测值，好在replay的时候和真实返回值比较的，刚刚才发现大错而特错了！这个函数是用来设定replay时期返回给调用方法的值的，也就是说整个测试过程中不会有实际的操作发生，所谓真正的运行方法调用也是在mock的框架下真的在模拟，返回值是之前给定的，也就是说没有办法测定待测函数的返回值是否正确！
</p><p>（过了三分钟）
</p><p>上面说的话作废一半，对于返回值的分析是正确的，但是结论是错误的，我们测的不是这个返回值，由于做范例的UserManager只是对UserDao进行了极其简单的封装，直接返回其对象，使得原本是“原料”位置的对象直接成为了“成品”。其实只要注意到mock对象模拟的不是UserManager，而是其成员UserDao，就应该可以明白其中的道理，我们为了测试UserManager是否正确，但又不想因为其所需要的资源耗费运行时间以及防止对系统进行修改（应该是这样吧），所以采用JUnit，采用EasyMock，采用InnoDB。而EasyMock正是将我们需要测试的类其中的成员进行模拟（而不是对测试对象本身），所以它直接要求必须指定有返回值的方法的返回值，将这个返回值返回给调用它的待测试类。这个返回值作为原料在待测试类中等待加工，之后待测试类将他自己的运行结果返回（这个结果甚至可能和前面那个返回值没有关系），而这个结果的正确性不是由EasyMock来保证的，需要我们用assert方法和预期的结果验证。
</p>
<div class="printfooter">
<p>取自"<a href="http://dns.cs.hit.edu.cn../../../e/a/s/EasyMock_89d9.html">http://dns.cs.hit.edu.cn../../../e/a/s/EasyMock_89d9.html</a>"</p>

<p>本页面已经被浏览29次。 This page was last modified 05:04 2006年7月22日 by <a href="../../../d/y/i/User%7EDyingcow.html" title="User:Dyingcow">刘奭</a>.  </p>
</div>

</div><br style="clear:both" />

<div id='footer'><table border="0" cellspacing="0"><tr><td width='152' rowspan='1'>&nbsp;</td><td class='bottom' align='left' valign='top'><strong><a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑本页</a></strong> |
<a href="../../../e/a/s/Talk%7EEasyMock_3ff6.html" class="new" title="Talk:EasyMock">讨论本页</a> |
<a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">较早版本</a> |
<a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a> |
<a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><br />

<br /><a href="../../../index.html" title="首页">首页</a> | <a href="../../../w/i/k/Wikipedia%7E%E5%85%B3%E4%BA%8E.html" title="Wikipedia:关于">关于Wikipedia</a> | <a href="../../../r/e/c/Special%7ERecentchanges.html" title="Special:Recentchanges">最近更改</a> | <form name="search" class="inline" method="post" action="../../../s/e/a/Special%7ESearch.html">
<input type="text" name="search" size="19" value="" />
<input type="submit" name="go" value="进入" />&nbsp;<input type="submit" name="fulltext" value="搜索" />
</form><br /><span id="pagestats">本页面已经被浏览29次。 This page was last modified 05:04 2006年7月22日 by <a href="../../../d/y/i/User%7EDyingcow.html" title="User:Dyingcow">刘奭</a>.  </span></td></tr></table>
</div>
</div>

<div id='quickbar'>
<a href='../../../index.html'><img src='../../../../skins/common/images/wiki.jpg' alt='[首页]' /></a>
<hr class='sep' /><a href="../../../index.html">首页</a>
<br /><a href="../../../c/o/m/WIKI-HIT_IBM_CLUB%7ECommunity_Portal_9150.html">社区</a>
<br /><a href="../../../c/u/r/Current_events.html">新闻动态</a>
<br /><a href="../../../r/e/c/Special%7ERecentchanges.html">最近更改</a>
<br /><a href="../../../r/a/n/Special%7ERandom.html">随机页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E5%B8%AE%E5%8A%A9.html">帮助</a>
<br /><a href="../../../s/i/t/WIKI-HIT_IBM_CLUB%7ESite_support.html">Donations</a>
<br />
<hr class='sep' /><strong><a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">编辑本页</a></strong>
<br /><a href="../../../e/a/s/Talk%7EEasyMock_3ff6.html" class="new" title="Talk:EasyMock">讨论本页</a>
<br /><a href="../../../e/a/s/EasyMock_89d9.html" title="EasyMock">较早版本</a>
<br /><a href="../../../w/h/a/Special%7EWhatlinkshere.html" title="Special:Whatlinkshere">链入页面</a>
<br /><a href="../../../r/e/c/Special%7ERecentchangeslinked.html" title="Special:Recentchangeslinked">链出更改</a>
<br /><hr class='sep' /><a href="../../../s/p/e/Special%7ESpecialpages.html" title="Special:Specialpages">特殊页面</a>
<br /><a href="../../../w/i/k/Wikipedia%7E%E9%94%99%E8%AF%AF%E6%8A%A5%E5%91%8A.html" title="Wikipedia:错误报告">错误报告</a>
<br /></div>
<!-- Served by dns.cs.hit.edu.cn in 1351392856.53 secs. -->
</body></html>